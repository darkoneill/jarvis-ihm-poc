name: LLM Provider Tests

on:
  workflow_dispatch:
    inputs:
      llm_provider:
        description: 'LLM Provider to test'
        required: true
        default: 'forge'
        type: choice
        options:
          - forge
          - ollama
          - openai
          - anthropic
          - all
  schedule:
    # Run daily at 6 AM UTC to verify LLM integrations
    - cron: '0 6 * * *'

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9'

jobs:
  # ============================================
  # Test Forge API
  # ============================================
  test-forge:
    name: Test Forge API
    runs-on: ubuntu-latest
    if: github.event.inputs.llm_provider == 'forge' || github.event.inputs.llm_provider == 'all' || github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup database
        run: pnpm db:push
        env:
          DATABASE_URL: file:./test.db

      - name: Test Forge API connection
        run: |
          pnpm test -- --grep "Forge"
        env:
          DATABASE_URL: file:./test.db
          LLM_PROVIDER: forge
          BUILT_IN_FORGE_API_URL: ${{ secrets.FORGE_API_URL }}
          BUILT_IN_FORGE_API_KEY: ${{ secrets.FORGE_API_KEY }}

      - name: Report results
        if: always()
        run: |
          echo "## Forge API Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Provider: Forge" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Test Ollama (with local installation)
  # ============================================
  test-ollama:
    name: Test Ollama Local
    runs-on: ubuntu-latest
    if: github.event.inputs.llm_provider == 'ollama' || github.event.inputs.llm_provider == 'all'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 5
          ollama pull llama3.2:1b  # Smallest model for CI

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup database
        run: pnpm db:push
        env:
          DATABASE_URL: file:./test.db

      - name: Test Ollama connection
        run: |
          # Verify Ollama is running
          curl -s http://localhost:11434/api/tags
          
          # Run tests
          pnpm test -- --grep "Ollama"
        env:
          DATABASE_URL: file:./test.db
          LLM_PROVIDER: ollama
          OLLAMA_URL: http://localhost:11434
          OLLAMA_MODEL: llama3.2:1b

      - name: Report results
        if: always()
        run: |
          echo "## Ollama Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Provider: Ollama" >> $GITHUB_STEP_SUMMARY
          echo "Model: llama3.2:1b" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Test OpenAI API
  # ============================================
  test-openai:
    name: Test OpenAI API
    runs-on: ubuntu-latest
    if: github.event.inputs.llm_provider == 'openai' || github.event.inputs.llm_provider == 'all'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup database
        run: pnpm db:push
        env:
          DATABASE_URL: file:./test.db

      - name: Test OpenAI API connection
        run: |
          pnpm test -- --grep "OpenAI"
        env:
          DATABASE_URL: file:./test.db
          LLM_PROVIDER: openai
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4o-mini

      - name: Report results
        if: always()
        run: |
          echo "## OpenAI Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Provider: OpenAI" >> $GITHUB_STEP_SUMMARY
          echo "Model: gpt-4o-mini" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Test Anthropic API
  # ============================================
  test-anthropic:
    name: Test Anthropic API
    runs-on: ubuntu-latest
    if: github.event.inputs.llm_provider == 'anthropic' || github.event.inputs.llm_provider == 'all'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup database
        run: pnpm db:push
        env:
          DATABASE_URL: file:./test.db

      - name: Test Anthropic API connection
        run: |
          pnpm test -- --grep "Anthropic"
        env:
          DATABASE_URL: file:./test.db
          LLM_PROVIDER: anthropic
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: claude-3-haiku-20240307

      - name: Report results
        if: always()
        run: |
          echo "## Anthropic Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Provider: Anthropic" >> $GITHUB_STEP_SUMMARY
          echo "Model: claude-3-haiku" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Summary Report
  # ============================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-forge, test-ollama, test-openai, test-anthropic]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# LLM Provider Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Provider | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Forge | ${{ needs.test-forge.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ollama | ${{ needs.test-ollama.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OpenAI | ${{ needs.test-openai.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Anthropic | ${{ needs.test-anthropic.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
